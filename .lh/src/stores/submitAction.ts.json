{
    "sourceFile": "src/stores/SubmitAction.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 36,
            "patches": [
                {
                    "date": 1681872641811,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1681872849367,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-19 10:50:40\n+ * @LastEditTime: 2023-04-19 10:54:09\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/submitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from \"./ChatStore\";\n@@ -36,8 +36,9 @@\n   if (chat) {\n     set((state) => {\n       return {\n         ...state,\n+        textareaMessage: '',\n         chats: state.chats.map((chat) => {\n           if (chat.id === activeChatId) {\n             return {\n               ...chat,\n"
                },
                {
                    "date": 1681872883460,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -20,11 +20,11 @@\n   const chat = findChat(activeChatId)\n \n   const newMessage: Message = {\n     message: textareaMessage,\n+    role: 'user',\n     id: uuidv4(),\n-    createdAt: new Date(),\n-    role: 'user'\n+    createdAt: new Date()\n   }\n \n   chat?.message.push(newMessage)\n \n"
                },
                {
                    "date": 1681872904306,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,7 +50,5 @@\n       }\n     })\n   }\n \n-  console.log('submit', submit)\n-\n }\n"
                },
                {
                    "date": 1681898699757,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,8 +7,9 @@\n  * @FilePath: /speak-gpt/src/stores/submitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from \"./ChatStore\";\n import { findChat } from \"./ChatAction\";\n+import { streamCompletion } from '@/fetch/openAI'\n import { v4 as uuidv4 } from \"uuid\";\n \n const get = useChatStore.getState;\n const set = useChatStore.setState;\n@@ -19,9 +20,9 @@\n   const textareaMessage = get().textareaMessage;\n   const chat = findChat(activeChatId)\n \n   const newMessage: Message = {\n-    message: textareaMessage,\n+    content: textareaMessage,\n     role: 'user',\n     id: uuidv4(),\n     createdAt: new Date()\n   }\n@@ -30,9 +31,9 @@\n \n   /**\n    * 提交最后 4 条内容\n    */\n-  const submit = chat?.message.slice(-4)\n+  const submit = chat?.message.slice(get().openAIHistory * -1)\n \n   if (chat) {\n     set((state) => {\n       return {\n@@ -50,5 +51,22 @@\n       }\n     })\n   }\n \n+  const GPTConfig = {\n+    model: get().openAIModels,\n+    temperature: get().temperature,\n+    top_p: number;\n+    n: number;\n+    stop: string;\n+    max_tokens: number;\n+    presence_penalty: number;\n+    frequency_penalty: number;\n+    logit_bias: string;\n+    auto_title: boolean;\n+  }\n+\n+  streamCompletion()\n+\n+\n+\n }\n"
                },
                {
                    "date": 1681899189684,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-19 10:54:09\n+ * @LastEditTime: 2023-04-19 18:13:07\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/submitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from \"./ChatStore\";\n@@ -31,9 +31,9 @@\n \n   /**\n    * 提交最后 4 条内容\n    */\n-  const submit = chat?.message.slice(get().openAIHistory * -1)\n+  const submitMessage: Message[] = chat?.message.slice(get().openAIHistory * -1)\n \n   if (chat) {\n     set((state) => {\n       return {\n@@ -51,22 +51,34 @@\n       }\n     })\n   }\n \n-  const GPTConfig = {\n-    model: get().openAIModels,\n-    temperature: get().temperature,\n-    top_p: number;\n-    n: number;\n-    stop: string;\n-    max_tokens: number;\n-    presence_penalty: number;\n-    frequency_penalty: number;\n-    logit_bias: string;\n-    auto_title: boolean;\n+  const GPTConfig = get().openAIConfig;\n+\n+  const openAIKey = get().openAIKey;\n+  if (openAIKey === undefined) {\n+    console.error(\"API key not set\");\n+    return;\n   }\n \n-  streamCompletion()\n+  const abortController = new AbortController();\n \n \n \n+  streamCompletion(\n+    submitMessage,\n+    GPTConfig,\n+    openAIKey,\n+    abortController,\n+    callback,\n+    endCallback\n+  )\n }\n+\n+\n+const callback = (content: any) => {\n+  console.log('content', content)\n+}\n+\n+const endCallback = (endChat: any) => {\n+  endChat\n+}\n"
                },
                {
                    "date": 1681899199468,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -31,9 +31,9 @@\n \n   /**\n    * 提交最后 4 条内容\n    */\n-  const submitMessage: Message[] = chat?.message.slice(get().openAIHistory * -1)\n+  const submitMessage = chat?.message.slice(get().openAIHistory * -1)\n \n   if (chat) {\n     set((state) => {\n       return {\n"
                },
                {
                    "date": 1681899208757,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,9 +64,9 @@\n \n \n \n   streamCompletion(\n-    submitMessage,\n+    submitMessage || [],\n     GPTConfig,\n     openAIKey,\n     abortController,\n     callback,\n"
                },
                {
                    "date": 1681973727886,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,31 +1,31 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-19 18:13:07\n+ * @LastEditTime: 2023-04-20 14:55:27\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n- * @FilePath: /speak-gpt/src/stores/submitAction.ts\n+ * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n-import { useChatStore, ChatState, Message, Chat } from \"./ChatStore\";\n-import { findChat } from \"./ChatAction\";\n+import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n+import { findChat } from './ChatAction'\n import { streamCompletion } from '@/fetch/openAI'\n-import { v4 as uuidv4 } from \"uuid\";\n+import { v4 as uuidv4 } from 'uuid'\n \n-const get = useChatStore.getState;\n-const set = useChatStore.setState;\n+const get = useChatStore.getState\n+const set = useChatStore.setState\n \n-\n export const submitMessage = () => {\n-  const activeChatId = get().activeChatId;\n-  const textareaMessage = get().textareaMessage;\n+  const activeChatId = get().activeChatId\n+  const textareaMessage = get().textareaMessage\n+  if (!activeChatId) return\n   const chat = findChat(activeChatId)\n \n   const newMessage: Message = {\n     content: textareaMessage,\n     role: 'user',\n     id: uuidv4(),\n-    createdAt: new Date()\n+    createdAt: new Date(),\n   }\n \n   chat?.message.push(newMessage)\n \n@@ -42,40 +42,37 @@\n         chats: state.chats.map((chat) => {\n           if (chat.id === activeChatId) {\n             return {\n               ...chat,\n-              message: chat.message\n+              message: chat.message,\n             }\n           }\n           return chat\n-        })\n+        }),\n       }\n     })\n   }\n \n-  const GPTConfig = get().openAIConfig;\n+  const GPTConfig = get().openAIConfig\n \n-  const openAIKey = get().openAIKey;\n+  const openAIKey = get().openAIKey\n   if (openAIKey === undefined) {\n-    console.error(\"API key not set\");\n-    return;\n+    console.error('API key not set')\n+    return\n   }\n \n-  const abortController = new AbortController();\n+  const abortController = new AbortController()\n \n-\n-\n   streamCompletion(\n     submitMessage || [],\n     GPTConfig,\n     openAIKey,\n     abortController,\n     callback,\n-    endCallback\n+    endCallback,\n   )\n }\n \n-\n const callback = (content: any) => {\n   console.log('content', content)\n }\n \n"
                },
                {
                    "date": 1681977103250,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 14:55:27\n+ * @LastEditTime: 2023-04-20 15:51:42\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -76,6 +76,6 @@\n   console.log('content', content)\n }\n \n const endCallback = (endChat: any) => {\n-  endChat\n+  console.log('enendChat', endChat)\n }\n"
                },
                {
                    "date": 1681979388080,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,14 +8,20 @@\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n import { findChat } from './ChatAction'\n import { streamCompletion } from '@/fetch/openAI'\n+import produce from 'immer'\n import { v4 as uuidv4 } from 'uuid'\n \n const get = useChatStore.getState\n const set = useChatStore.setState\n \n export const submitMessage = () => {\n+  const openAIKey = get().openAIKey\n+  if (!openAIKey) {\n+    return\n+  }\n+\n   const activeChatId = get().activeChatId\n   const textareaMessage = get().textareaMessage\n   if (!activeChatId) return\n   const chat = findChat(activeChatId)\n@@ -28,13 +34,8 @@\n   }\n \n   chat?.message.push(newMessage)\n \n-  /**\n-   * 提交最后 4 条内容\n-   */\n-  const submitMessage = chat?.message.slice(get().openAIHistory * -1)\n-\n   if (chat) {\n     set((state) => {\n       return {\n         ...state,\n@@ -51,31 +52,75 @@\n       }\n     })\n   }\n \n+  /**\n+   * 提交最后 4 条内容\n+   */\n+  const submitMessage = chat?.message.slice(get().openAIHistory * -1)\n+  const abortController = new AbortController()\n   const GPTConfig = get().openAIConfig\n+  const activeChat = findChat(activeChatId)\n+  let flag = false\n \n-  const openAIKey = get().openAIKey\n-  if (openAIKey === undefined) {\n-    console.error('API key not set')\n-    return\n+  const botRequestMessage: Message = {\n+    content: textareaMessage,\n+    role: 'bot',\n+    id: uuidv4(),\n+    createdAt: new Date(),\n   }\n \n-  const abortController = new AbortController()\n-\n   streamCompletion(\n     submitMessage || [],\n     GPTConfig,\n     openAIKey,\n     abortController,\n-    callback,\n+    (content: any) => {\n+      if (!flag) {\n+        chat?.message.push(botRequestMessage)\n+        set((state) => {\n+          return {\n+            ...state,\n+            textareaMessage: '',\n+            chats: state.chats.map((chat) => {\n+              if (chat.id === activeChatId) {\n+                return {\n+                  ...chat,\n+                  message: chat.message,\n+                }\n+              }\n+              return chat\n+            }),\n+          }\n+        })\n+      }\n+\n+      set(\n+        produce((draft) => {\n+          draft.chats\n+        }),\n+      )\n+    },\n     endCallback,\n   )\n }\n \n-const callback = (content: any) => {\n-  console.log('content', content)\n-}\n-\n const endCallback = (endChat: any) => {\n   console.log('enendChat', endChat)\n }\n+\n+const updateChatMessage = (newChat: Chat, id: string, message: Message) => {\n+  // set((state) => {\n+  //   return {\n+  //     ...state,\n+  //     chats: state.chats.map((chat) => {\n+  //       if (chat.id === id) {\n+  //         return {\n+  //           ...chat,\n+  //           message: chat.message,\n+  //         }\n+  //       }\n+  //       return chat\n+  //     }),\n+  //   }\n+  // })\n+}\n"
                },
                {
                    "date": 1681979967219,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,58 +1,63 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 15:51:42\n+ * @LastEditTime: 2023-04-20 16:39:25\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n-import { findChat } from './ChatAction'\n+// import { findChat } from './ChatAction'\n import { streamCompletion } from '@/fetch/openAI'\n import produce from 'immer'\n import { v4 as uuidv4 } from 'uuid'\n \n const get = useChatStore.getState\n const set = useChatStore.setState\n \n export const submitMessage = () => {\n-  const openAIKey = get().openAIKey\n-  if (!openAIKey) {\n+  const { openAIKey, activeChatId, textareaMessage, chats } = get()\n+  if (\n+    !openAIKey ||\n+    !activeChatId ||\n+    !textareaMessage.length ||\n+    !chats[activeChatId]\n+  ) {\n     return\n   }\n \n-  const activeChatId = get().activeChatId\n-  const textareaMessage = get().textareaMessage\n-  if (!activeChatId) return\n-  const chat = findChat(activeChatId)\n-\n   const newMessage: Message = {\n     content: textareaMessage,\n     role: 'user',\n     id: uuidv4(),\n     createdAt: new Date(),\n   }\n+  chats[activeChatId].message.push(newMessage)\n \n-  chat?.message.push(newMessage)\n+  set((state) => ({\n+    ...state,\n+    textareaMessage: '',\n+    chats,\n+  }))\n \n-  if (chat) {\n-    set((state) => {\n-      return {\n-        ...state,\n-        textareaMessage: '',\n-        chats: state.chats.map((chat) => {\n-          if (chat.id === activeChatId) {\n-            return {\n-              ...chat,\n-              message: chat.message,\n-            }\n-          }\n-          return chat\n-        }),\n-      }\n-    })\n-  }\n+  // if (chat) {\n+  //   set((state) => {\n+  //     return {\n+  //       ...state,\n+  //       textareaMessage: '',\n+  //       chats: state.chats.map((chat) => {\n+  //         if (chat.id === activeChatId) {\n+  //           return {\n+  //             ...chat,\n+  //             message: chat.message,\n+  //           }\n+  //         }\n+  //         return chat\n+  //       }),\n+  //     }\n+  //   })\n+  // }\n \n   /**\n    * 提交最后 4 条内容\n    */\n@@ -76,23 +81,8 @@\n     abortController,\n     (content: any) => {\n       if (!flag) {\n         chat?.message.push(botRequestMessage)\n-        set((state) => {\n-          return {\n-            ...state,\n-            textareaMessage: '',\n-            chats: state.chats.map((chat) => {\n-              if (chat.id === activeChatId) {\n-                return {\n-                  ...chat,\n-                  message: chat.message,\n-                }\n-              }\n-              return chat\n-            }),\n-          }\n-        })\n       }\n \n       set(\n         produce((draft) => {\n"
                },
                {
                    "date": 1681980029957,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 16:39:25\n+ * @LastEditTime: 2023-04-20 16:40:27\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -60,39 +60,38 @@\n \n   /**\n    * 提交最后 4 条内容\n    */\n-  const submitMessage = chat?.message.slice(get().openAIHistory * -1)\n-  const abortController = new AbortController()\n-  const GPTConfig = get().openAIConfig\n-  const activeChat = findChat(activeChatId)\n-  let flag = false\n+  // const submitMessage = chat?.message.slice(get().openAIHistory * -1)\n+  // const abortController = new AbortController()\n+  // const GPTConfig = get().openAIConfig\n+  // let flag = false\n \n-  const botRequestMessage: Message = {\n-    content: textareaMessage,\n-    role: 'bot',\n-    id: uuidv4(),\n-    createdAt: new Date(),\n-  }\n+  // const botRequestMessage: Message = {\n+  //   content: textareaMessage,\n+  //   role: 'bot',\n+  //   id: uuidv4(),\n+  //   createdAt: new Date(),\n+  // }\n \n-  streamCompletion(\n-    submitMessage || [],\n-    GPTConfig,\n-    openAIKey,\n-    abortController,\n-    (content: any) => {\n-      if (!flag) {\n-        chat?.message.push(botRequestMessage)\n-      }\n+  // streamCompletion(\n+  //   submitMessage || [],\n+  //   GPTConfig,\n+  //   openAIKey,\n+  //   abortController,\n+  //   (content: any) => {\n+  //     if (!flag) {\n+  //       chat?.message.push(botRequestMessage)\n+  //     }\n \n-      set(\n-        produce((draft) => {\n-          draft.chats\n-        }),\n-      )\n-    },\n-    endCallback,\n-  )\n+  //     set(\n+  //       produce((draft) => {\n+  //         draft.chats\n+  //       }),\n+  //     )\n+  //   },\n+  //   endCallback,\n+  // )\n }\n \n const endCallback = (endChat: any) => {\n   console.log('enendChat', endChat)\n"
                },
                {
                    "date": 1681981286501,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,9 +7,9 @@\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n // import { findChat } from './ChatAction'\n-import { streamCompletion } from '@/fetch/openAI'\n+import { streamCompletion } from '@/fetchs/openAI'\n import produce from 'immer'\n import { v4 as uuidv4 } from 'uuid'\n \n const get = useChatStore.getState\n"
                },
                {
                    "date": 1681981698300,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 16:40:27\n+ * @LastEditTime: 2023-04-20 17:08:16\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -32,9 +32,9 @@\n     id: uuidv4(),\n     createdAt: new Date(),\n   }\n   chats[activeChatId].message.push(newMessage)\n-\n+  console.log('chats>>>>s', chats)\n   set((state) => ({\n     ...state,\n     textareaMessage: '',\n     chats,\n"
                },
                {
                    "date": 1681981890854,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 17:08:16\n+ * @LastEditTime: 2023-04-20 17:11:30\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -32,14 +32,14 @@\n     id: uuidv4(),\n     createdAt: new Date(),\n   }\n   chats[activeChatId].message.push(newMessage)\n-  console.log('chats>>>>s', chats)\n-  set((state) => ({\n-    ...state,\n-    textareaMessage: '',\n-    chats,\n-  }))\n+  set(\n+    produce((draft) => {\n+      draft.chats = chats\n+      draft.textareaMessage = ''\n+    }),\n+  )\n \n   // if (chat) {\n   //   set((state) => {\n   //     return {\n"
                },
                {
                    "date": 1681981999304,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 17:11:30\n+ * @LastEditTime: 2023-04-20 17:13:18\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -31,8 +31,9 @@\n     role: 'user',\n     id: uuidv4(),\n     createdAt: new Date(),\n   }\n+  console.log('chats[activeChatId]>>>>', chats[activeChatId])\n   chats[activeChatId].message.push(newMessage)\n   set(\n     produce((draft) => {\n       draft.chats = chats\n"
                },
                {
                    "date": 1681982178049,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 17:13:18\n+ * @LastEditTime: 2023-04-20 17:16:17\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -31,13 +31,13 @@\n     role: 'user',\n     id: uuidv4(),\n     createdAt: new Date(),\n   }\n-  console.log('chats[activeChatId]>>>>', chats[activeChatId])\n-  chats[activeChatId].message.push(newMessage)\n+  // console.log('chats[activeChatId]>>>>', chats[activeChatId])\n+  // chats[activeChatId].message.push(newMessage)\n   set(\n     produce((draft) => {\n-      draft.chats = chats\n+      draft.chats[activeChatId].message.push(newMessage)\n       draft.textareaMessage = ''\n     }),\n   )\n \n"
                },
                {
                    "date": 1681982727394,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 17:16:17\n+ * @LastEditTime: 2023-04-20 17:25:19\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -31,34 +31,11 @@\n     role: 'user',\n     id: uuidv4(),\n     createdAt: new Date(),\n   }\n-  // console.log('chats[activeChatId]>>>>', chats[activeChatId])\n-  // chats[activeChatId].message.push(newMessage)\n-  set(\n-    produce((draft) => {\n-      draft.chats[activeChatId].message.push(newMessage)\n-      draft.textareaMessage = ''\n-    }),\n-  )\n \n-  // if (chat) {\n-  //   set((state) => {\n-  //     return {\n-  //       ...state,\n-  //       textareaMessage: '',\n-  //       chats: state.chats.map((chat) => {\n-  //         if (chat.id === activeChatId) {\n-  //           return {\n-  //             ...chat,\n-  //             message: chat.message,\n-  //           }\n-  //         }\n-  //         return chat\n-  //       }),\n-  //     }\n-  //   })\n-  // }\n+  pushActiveMessage(activeChatId, newMessage)\n+  set(() => ({ textareaMessage: '' }))\n \n   /**\n    * 提交最后 4 条内容\n    */\n@@ -97,20 +74,11 @@\n const endCallback = (endChat: any) => {\n   console.log('enendChat', endChat)\n }\n \n-const updateChatMessage = (newChat: Chat, id: string, message: Message) => {\n-  // set((state) => {\n-  //   return {\n-  //     ...state,\n-  //     chats: state.chats.map((chat) => {\n-  //       if (chat.id === id) {\n-  //         return {\n-  //           ...chat,\n-  //           message: chat.message,\n-  //         }\n-  //       }\n-  //       return chat\n-  //     }),\n-  //   }\n-  // })\n+const pushActiveMessage = (activeChatId: string, message: Message) => {\n+  set(\n+    produce((draft) => {\n+      draft.chats[activeChatId].message.push(message)\n+    }),\n+  )\n }\n"
                },
                {
                    "date": 1681983970662,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 17:25:19\n+ * @LastEditTime: 2023-04-20 17:46:07\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -38,38 +38,43 @@\n \n   /**\n    * 提交最后 4 条内容\n    */\n-  // const submitMessage = chat?.message.slice(get().openAIHistory * -1)\n-  // const abortController = new AbortController()\n-  // const GPTConfig = get().openAIConfig\n-  // let flag = false\n+  const submitMessage = chats[activeChatId].message.slice(\n+    get().openAIHistory * -1,\n+  )\n+  const abortController = new AbortController()\n+  const GPTConfig = get().openAIConfig\n+  let firstResponse = false\n+  const responseMessageId = uuidv4()\n \n-  // const botRequestMessage: Message = {\n-  //   content: textareaMessage,\n-  //   role: 'bot',\n-  //   id: uuidv4(),\n-  //   createdAt: new Date(),\n-  // }\n+  const botResponseMessage: Message = {\n+    content: '',\n+    role: 'bot',\n+    id: responseMessageId,\n+    createdAt: new Date(),\n+  }\n \n-  // streamCompletion(\n-  //   submitMessage || [],\n-  //   GPTConfig,\n-  //   openAIKey,\n-  //   abortController,\n-  //   (content: any) => {\n-  //     if (!flag) {\n-  //       chat?.message.push(botRequestMessage)\n-  //     }\n+  streamCompletion(\n+    submitMessage || [],\n+    GPTConfig,\n+    openAIKey,\n+    abortController,\n+    (content: any) => {\n+      if (firstResponse) {\n+        pushActiveMessage(activeChatId, { ...botResponseMessage, content })\n+        firstResponse = true\n+      }\n \n-  //     set(\n-  //       produce((draft) => {\n-  //         draft.chats\n-  //       }),\n-  //     )\n-  //   },\n-  //   endCallback,\n-  // )\n+      set(\n+        produce((draft) => {\n+          draft.chats[activeChatId].message[responseMessageId].content +=\n+            content\n+        }),\n+      )\n+    },\n+    endCallback,\n+  )\n }\n \n const endCallback = (endChat: any) => {\n   console.log('enendChat', endChat)\n"
                },
                {
                    "date": 1681984188176,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 17:46:07\n+ * @LastEditTime: 2023-04-20 17:49:46\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -43,9 +43,9 @@\n     get().openAIHistory * -1,\n   )\n   const abortController = new AbortController()\n   const GPTConfig = get().openAIConfig\n-  let firstResponse = false\n+  let firstResponse = true\n   const responseMessageId = uuidv4()\n \n   const botResponseMessage: Message = {\n     content: '',\n@@ -61,15 +61,15 @@\n     abortController,\n     (content: any) => {\n       if (firstResponse) {\n         pushActiveMessage(activeChatId, { ...botResponseMessage, content })\n-        firstResponse = true\n+        firstResponse = false\n       }\n \n       set(\n         produce((draft) => {\n-          draft.chats[activeChatId].message[responseMessageId].content +=\n-            content\n+          const len = draft.chats[activeChatId].message.length\n+          draft.chats[activeChatId].message[len - 1].content += content\n         }),\n       )\n     },\n     endCallback,\n"
                },
                {
                    "date": 1681984423526,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -48,9 +48,9 @@\n   const responseMessageId = uuidv4()\n \n   const botResponseMessage: Message = {\n     content: '',\n-    role: 'bot',\n+    role: 'assistant',\n     id: responseMessageId,\n     createdAt: new Date(),\n   }\n \n"
                },
                {
                    "date": 1681984597581,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 17:49:46\n+ * @LastEditTime: 2023-04-20 17:56:37\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -41,8 +41,10 @@\n    */\n   const submitMessage = chats[activeChatId].message.slice(\n     get().openAIHistory * -1,\n   )\n+\n+  console.log('submitMessage', submitMessage)\n   const abortController = new AbortController()\n   const GPTConfig = get().openAIConfig\n   let firstResponse = true\n   const responseMessageId = uuidv4()\n"
                },
                {
                    "date": 1682008434905,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-20 17:56:37\n+ * @LastEditTime: 2023-04-21 00:33:54\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -73,16 +73,14 @@\n           draft.chats[activeChatId].message[len - 1].content += content\n         }),\n       )\n     },\n-    endCallback,\n+    (endChat: any) => {\n+      console.log('enendChat', endChat)\n+    },\n   )\n }\n \n-const endCallback = (endChat: any) => {\n-  console.log('enendChat', endChat)\n-}\n-\n const pushActiveMessage = (activeChatId: string, message: Message) => {\n   set(\n     produce((draft) => {\n       draft.chats[activeChatId].message.push(message)\n"
                },
                {
                    "date": 1682008496532,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-21 00:33:54\n+ * @LastEditTime: 2023-04-21 00:34:55\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -62,9 +62,9 @@\n     openAIKey,\n     abortController,\n     (content: any) => {\n       if (firstResponse) {\n-        pushActiveMessage(activeChatId, { ...botResponseMessage, content })\n+        pushActiveMessage(activeChatId, botResponseMessage)\n         firstResponse = false\n       }\n \n       set(\n"
                },
                {
                    "date": 1682008521599,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,12 +39,11 @@\n   /**\n    * 提交最后 4 条内容\n    */\n   const submitMessage = chats[activeChatId].message.slice(\n-    get().openAIHistory * -1,\n+    get().openAIHistory * -1 - 1,\n   )\n \n-  console.log('submitMessage', submitMessage)\n   const abortController = new AbortController()\n   const GPTConfig = get().openAIConfig\n   let firstResponse = true\n   const responseMessageId = uuidv4()\n"
                },
                {
                    "date": 1682008646009,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-21 00:34:55\n+ * @LastEditTime: 2023-04-21 00:37:24\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -32,18 +32,19 @@\n     id: uuidv4(),\n     createdAt: new Date(),\n   }\n \n-  pushActiveMessage(activeChatId, newMessage)\n-  set(() => ({ textareaMessage: '' }))\n-\n   /**\n    * 提交最后 4 条内容\n    */\n   const submitMessage = chats[activeChatId].message.slice(\n-    get().openAIHistory * -1 - 1,\n+    get().openAIHistory * -1 + 1,\n   )\n+  submitMessage.push(newMessage)\n \n+  pushActiveMessage(activeChatId, newMessage)\n+  set(() => ({ textareaMessage: '' }))\n+\n   const abortController = new AbortController()\n   const GPTConfig = get().openAIConfig\n   let firstResponse = true\n   const responseMessageId = uuidv4()\n"
                },
                {
                    "date": 1682008838237,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-21 00:37:24\n+ * @LastEditTime: 2023-04-21 00:40:37\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -40,8 +40,10 @@\n     get().openAIHistory * -1 + 1,\n   )\n   submitMessage.push(newMessage)\n \n+  console.log('submitMessage', submitMessage)\n+\n   pushActiveMessage(activeChatId, newMessage)\n   set(() => ({ textareaMessage: '' }))\n \n   const abortController = new AbortController()\n"
                },
                {
                    "date": 1682009536708,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-21 00:40:37\n+ * @LastEditTime: 2023-04-21 00:52:15\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -40,10 +40,11 @@\n     get().openAIHistory * -1 + 1,\n   )\n   submitMessage.push(newMessage)\n \n-  console.log('submitMessage', submitMessage)\n-\n+  /**\n+   * 将用户数据存储至 store中\n+   */\n   pushActiveMessage(activeChatId, newMessage)\n   set(() => ({ textareaMessage: '' }))\n \n   const abortController = new AbortController()\n"
                },
                {
                    "date": 1682009598403,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-21 00:52:15\n+ * @LastEditTime: 2023-04-21 00:53:18\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -36,11 +36,10 @@\n   /**\n    * 提交最后 4 条内容\n    */\n   const submitMessage = chats[activeChatId].message.slice(\n-    get().openAIHistory * -1 + 1,\n+    get().openAIHistory * -1,\n   )\n-  submitMessage.push(newMessage)\n \n   /**\n    * 将用户数据存储至 store中\n    */\n"
                },
                {
                    "date": 1682009605226,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-21 00:53:18\n+ * @LastEditTime: 2023-04-21 00:52:15\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n"
                },
                {
                    "date": 1682009620396,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,8 +39,9 @@\n   const submitMessage = chats[activeChatId].message.slice(\n     get().openAIHistory * -1,\n   )\n \n+  console.log('submitMessage', submitMessage)\n   /**\n    * 将用户数据存储至 store中\n    */\n   pushActiveMessage(activeChatId, newMessage)\n"
                },
                {
                    "date": 1682009650131,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -38,9 +38,9 @@\n    */\n   const submitMessage = chats[activeChatId].message.slice(\n     get().openAIHistory * -1,\n   )\n-\n+  console.log('chats[activeChatId]', chats[activeChatId])\n   console.log('submitMessage', submitMessage)\n   /**\n    * 将用户数据存储至 store中\n    */\n"
                },
                {
                    "date": 1682009727236,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-21 00:52:15\n+ * @LastEditTime: 2023-04-21 00:55:27\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -36,12 +36,15 @@\n   /**\n    * 提交最后 4 条内容\n    */\n   const submitMessage = chats[activeChatId].message.slice(\n-    get().openAIHistory * -1,\n+    (get().openAIHistory - 1) * -1,\n   )\n+\n   console.log('chats[activeChatId]', chats[activeChatId])\n   console.log('submitMessage', submitMessage)\n+  submitMessage.push(newMessage)\n+  console.log('submitMessage', submitMessage)\n   /**\n    * 将用户数据存储至 store中\n    */\n   pushActiveMessage(activeChatId, newMessage)\n"
                },
                {
                    "date": 1682009732536,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,11 +40,11 @@\n     (get().openAIHistory - 1) * -1,\n   )\n \n   console.log('chats[activeChatId]', chats[activeChatId])\n-  console.log('submitMessage', submitMessage)\n+  console.log('submitMessage1', submitMessage)\n   submitMessage.push(newMessage)\n-  console.log('submitMessage', submitMessage)\n+  console.log('submitMessage2', submitMessage)\n   /**\n    * 将用户数据存储至 store中\n    */\n   pushActiveMessage(activeChatId, newMessage)\n"
                },
                {
                    "date": 1682009802495,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-21 00:55:27\n+ * @LastEditTime: 2023-04-21 00:56:41\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -42,9 +42,9 @@\n \n   console.log('chats[activeChatId]', chats[activeChatId])\n   console.log('submitMessage1', submitMessage)\n   submitMessage.push(newMessage)\n-  console.log('submitMessage2', submitMessage)\n+  console.log('submitMessage2', submitMessage.reverse())\n   /**\n    * 将用户数据存储至 store中\n    */\n   pushActiveMessage(activeChatId, newMessage)\n"
                },
                {
                    "date": 1682010121421,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,9 +1,9 @@\n /*\n  * @Author: Allen OYang\n  * @Email:  allenwill211@gmail.com\n  * @Date: 2023-04-19 10:23:55\n- * @LastEditTime: 2023-04-21 00:56:41\n+ * @LastEditTime: 2023-04-21 01:01:59\n  * @LastEditors: Allen OYang allenwill211@gmail.com\n  * @FilePath: /speak-gpt/src/stores/SubmitAction.ts\n  */\n import { useChatStore, ChatState, Message, Chat } from './ChatStore'\n@@ -39,12 +39,10 @@\n   const submitMessage = chats[activeChatId].message.slice(\n     (get().openAIHistory - 1) * -1,\n   )\n \n-  console.log('chats[activeChatId]', chats[activeChatId])\n-  console.log('submitMessage1', submitMessage)\n   submitMessage.push(newMessage)\n-  console.log('submitMessage2', submitMessage.reverse())\n+  console.log('submitMessage', submitMessage)\n   /**\n    * 将用户数据存储至 store中\n    */\n   pushActiveMessage(activeChatId, newMessage)\n"
                }
            ],
            "date": 1681872641811,
            "name": "Commit-0",
            "content": "/*\n * @Author: Allen OYang\n * @Email:  allenwill211@gmail.com\n * @Date: 2023-04-19 10:23:55\n * @LastEditTime: 2023-04-19 10:50:40\n * @LastEditors: Allen OYang allenwill211@gmail.com\n * @FilePath: /speak-gpt/src/stores/submitAction.ts\n */\nimport { useChatStore, ChatState, Message, Chat } from \"./ChatStore\";\nimport { findChat } from \"./ChatAction\";\nimport { v4 as uuidv4 } from \"uuid\";\n\nconst get = useChatStore.getState;\nconst set = useChatStore.setState;\n\n\nexport const submitMessage = () => {\n  const activeChatId = get().activeChatId;\n  const textareaMessage = get().textareaMessage;\n  const chat = findChat(activeChatId)\n\n  const newMessage: Message = {\n    message: textareaMessage,\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: 'user'\n  }\n\n  chat?.message.push(newMessage)\n\n  /**\n   * 提交最后 4 条内容\n   */\n  const submit = chat?.message.slice(-4)\n\n  if (chat) {\n    set((state) => {\n      return {\n        ...state,\n        chats: state.chats.map((chat) => {\n          if (chat.id === activeChatId) {\n            return {\n              ...chat,\n              message: chat.message\n            }\n          }\n          return chat\n        })\n      }\n    })\n  }\n\n  console.log('submit', submit)\n\n}\n"
        }
    ]
}